<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pinet.rest.mapper.CustomerMemberMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.pinet.rest.entity.CustomerMember">
        <result column="id" property="id" />
        <result column="create_by" property="createBy" />
        <result column="create_time" property="createTime" />
        <result column="update_by" property="updateBy" />
        <result column="update_time" property="updateTime" />
        <result column="del_flag" property="delFlag" />
        <result column="customer_id" property="customerId" />
        <result column="member_level" property="memberLevel" />
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="Base_Column_List">
        id,
        create_by,
        create_time,
        update_by,
        update_time,
        del_flag,
        customer_id, member_level
    </sql>
    <select id="selectMemberRecommendProd" resultType="com.pinet.rest.entity.vo.MemberRecommendProdVo">
        SELECT
            p.id productId,
            p.product_img productImg,
            p.product_name productName,
            p. marketPrice,
            sp.salesCount
        FROM
            (
                SELECT
                    p.id,
                    product_name,
                    product_img,
                    MAX( sp.market_price )  marketPrice
                FROM
                    product p
                        LEFT JOIN product_spec sp ON sp.product_id = p.id
                GROUP BY
                    p.id
            ) p
                LEFT JOIN (
                SELECT
                    sp.prod_id,
                    SUM( op.prod_num ) salesCount
                FROM
                    order_product op
                        LEFT JOIN shop_product sp ON sp.id = op.shop_prod_id
                GROUP BY
                    sp.prod_id
            ) sp ON sp.prod_id = p.id order by sp.salesCount desc
    </select>

</mapper>
